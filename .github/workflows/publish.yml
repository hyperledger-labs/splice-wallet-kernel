name: Publish packages
run-name: Publishing to npm

on:
    push:
        branches:
            - 'release/**'
            - 'phol/release/testing'
permissions:
    contents: read
jobs:
    release:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  fetch-tags: true

            - name: Enable Corepack
              run: corepack enable

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 'v22.16.0'
                  cache: 'yarn'

            - name: Install dependencies
              run: yarn install --immutable

            - name: Generate
              run: yarn generate:all

            - name: Build
              run: yarn build:all

            - name: Check version
              run: |
                  BRANCH_NAME="${GITHUB_REF#refs/heads/}"
                  BRANCH_VERSION=$(echo "$BRANCH_NAME" | sed -E 's/^release\/(v?([0-9]+\.[0-9]+\.[0-9]+.*))/\2/')
                  BRANCH_MAJOR=$(echo "$BRANCH_VERSION" | sed -E 's/^([0-9]+)\..*/\1/')

                  echo "Branch: $BRANCH_NAME"
                  echo "Branch version: $BRANCH_VERSION"
                  echo "Expected major version: $BRANCH_MAJOR"
                  echo ""

                  # Get all workspace package versions
                  VERSIONS=$(yarn workspaces list --json --no-private | jq -r '.location' | while read workspace; do
                    if [ -f "$workspace/package.json" ]; then
                      jq -r '.version // empty' "$workspace/package.json"
                    fi
                  done | sort -u)

                  MAJOR_VERSIONS=$(echo "$VERSIONS" | sed -E 's/^([0-9]+)\..*/\1/' | sort -u)
                  COUNT=$(echo "$MAJOR_VERSIONS" | wc -l)

                  # Check if all workspaces have the same major version
                  if [ "$COUNT" -ne 1 ]; then
                    echo "Error: Workspaces have mismatched major versions!"
                    echo "Found major versions: $MAJOR_VERSIONS"
                    echo ""
                    echo "All workspace versions:"
                    yarn workspaces list --json --no-private | jq -r '.location' | while read workspace; do
                      if [ -f "$workspace/package.json" ]; then
                        VERSION=$(jq -r '.version // empty' "$workspace/package.json")
                        NAME=$(jq -r '.name' "$workspace/package.json")
                        echo "  $NAME: $VERSION"
                      fi
                    done
                    exit 1
                  fi

                  WORKSPACE_MAJOR="$MAJOR_VERSIONS"

                  # Check if workspace major version matches branch major version
                  if [ "$WORKSPACE_MAJOR" != "$BRANCH_MAJOR" ]; then
                    echo "Error: Workspace major version ($WORKSPACE_MAJOR) does not match branch major version ($BRANCH_MAJOR)!"
                    echo ""
                    echo "All workspace versions:"
                    yarn workspaces list --json --no-private | jq -r '.location' | while read workspace; do
                      if [ -f "$workspace/package.json" ]; then
                        VERSION=$(jq -r '.version // empty' "$workspace/package.json")
                        NAME=$(jq -r '.name' "$workspace/package.json")
                        echo "  $NAME: $VERSION"
                      fi
                    done
                    exit 1
                  fi

                  echo "All workspaces have major version $WORKSPACE_MAJOR matching branch version $BRANCH_VERSION"

            # NX does not currently support publishing through yarn: https://github.com/nrwl/nx/issues/29242
            # So we publish all workspaces through yarn directly
            - name: Publish
              run: |
                  yarn config set npmAuthToken ${{ secrets.NPM_TOKEN_DA }}
                  # yarn workspaces foreach --no-private -t -A --include 'core/*' --include 'sdk/*' --include 'wallet-gateway/*' npm publish --tolerate-republish
