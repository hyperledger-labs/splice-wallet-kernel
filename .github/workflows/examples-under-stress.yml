name: Examples Under Stress
permissions:
    contents: read

on:
    workflow_dispatch:
        inputs:
            ref:
                description: 'Branch/commit/PR to test (e.g. your-branch-name, main, or refs/pull/123/head). Leave empty to use default branch.'
                default: ''
            network:
                description: 'Localnet version'
                type: choice
                options: [devnet, mainnet]
                default: devnet
            parties_per_interval:
                description: 'PARTIES_PER_INTERVAL'
                default: '3'
            interval_length_ms:
                description: 'INTERVAL_LENGTH_MS'
                default: '5000'
            transfers_per_party:
                description: 'TRANSFERS_PER_PARTY'
                default: '5'
            stress_log_level:
                description: 'BACKGROUND_STRESS_LOG_LEVEL'
                default: 'silent'

jobs:
    stress-e2e:
        runs-on: ubuntu-latest
        timeout-minutes: 120

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.inputs.ref || github.ref }}

            - uses: ./.github/actions/setup_yarn

            - name: run codegen
              run: yarn generate:all

            - name: Build project
              run: yarn build:all

            - name: Download localnet (${{ github.event.inputs.network }})
              run: yarn script:fetch:localnet -- --network=${{ github.event.inputs.network }}

            - name: Start localnet (${{ github.event.inputs.network }})
              run: yarn start:localnet -- --network=${{ github.event.inputs.network }}

            - uses: ./.github/actions/check_resources

            - name: Run example scripts under background stress
              env:
                  PARTIES_PER_INTERVAL: ${{ github.event.inputs.parties_per_interval || '3' }}
                  INTERVAL_LENGTH_MS: ${{ github.event.inputs.interval_length_ms || '5000' }}
                  TRANSFERS_PER_PARTY: ${{ github.event.inputs.transfers_per_party || '5' }}
                  BACKGROUND_STRESS_LOG_LEVEL: ${{ github.event.inputs.stress_log_level || 'silent' }}
              run: yarn script:test:examples-stress

            - uses: ./.github/actions/check_resources

            - name: Stop localnet (${{ github.event.inputs.network }})
              if: always()
              run: yarn stop:localnet -- --network=${{ github.event.inputs.network }}

            - name: Save container logs (on failure)
              if: failure()
              run: |
                  set -euo pipefail
                  mkdir -p logs
                  for c in $(docker ps -a --format '{{.Names}}'); do
                    docker logs "$c" &> "logs/$c.log" || true
                  done

            - name: Upload logs as artifacts
              if: failure()
              uses: actions/upload-artifact@v4
              with:
                  name: docker-logs-${{ github.event.inputs.network }}
                  path: logs/
