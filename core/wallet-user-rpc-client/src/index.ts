// Code generated by @open-rpc/generator DO NOT EDIT.
import {
    RequestManager,
    PostMessageWindowTransport,
    PostMessageIframeTransport,
    WebSocketTransport,
    HTTPTransport,
    Client,
    JSONRPCError,
} from '@open-rpc/client-js'
import _ from 'lodash'
import { OpenrpcDocument as OpenRPC, MethodObject } from '@open-rpc/meta-schema'
import {
    MethodCallValidator,
    MethodNotFoundError,
    parseOpenRPCDocument,
} from '@open-rpc/schema-utils-js'

export type StringDoaGddGA = string
export interface AddNetworkParams {
    [key: string]: any
}
export interface AllocatePartyParams {
    hint: StringDoaGddGA
    [k: string]: any
}
export interface RemovePartyParams {
    hint: StringDoaGddGA
    [k: string]: any
}
export interface SignParams {
    data: StringDoaGddGA
    party?: StringDoaGddGA
    [k: string]: any
}
export interface ExecuteParams {
    signature: StringDoaGddGA
    party: StringDoaGddGA
    signedBy: StringDoaGddGA
    [k: string]: any
}
/**
 *
 * Represents a null value, used in responses where no data is returned.
 *
 */
export type Null = any
export interface AllocatePartyResult {
    [key: string]: any
}
export interface RemovePartyResult {
    [key: string]: any
}
export interface SignResult {
    signature: StringDoaGddGA
    party: StringDoaGddGA
    signedBy: StringDoaGddGA
    [k: string]: any
}
export interface ExecuteResult {
    correlationId: StringDoaGddGA
    traceId: StringDoaGddGA
    [k: string]: any
}
/**
 *
 * Generated! Represents an alias to any of the provided schemas
 *
 */
export type AnyOfAddNetworkParamsAllocatePartyParamsRemovePartyParamsSignParamsExecuteParamsNullAllocatePartyResultRemovePartyResultSignResultExecuteResult =

        | AddNetworkParams
        | AllocatePartyParams
        | RemovePartyParams
        | SignParams
        | ExecuteParams
        | Null
        | AllocatePartyResult
        | RemovePartyResult
        | SignResult
        | ExecuteResult
export type AddNetwork = (network: AddNetworkParams) => Promise<Null>
export type AllocateParty = (
    params: AllocatePartyParams
) => Promise<AllocatePartyResult>
export type RemoveParty = (
    params: RemovePartyParams
) => Promise<RemovePartyResult>
export type Sign = (params: SignParams) => Promise<SignResult>
export type Execute = (params: ExecuteParams) => Promise<ExecuteResult>

export interface Options {
    transport: {
        type:
            | 'websocket'
            | 'http'
            | 'https'
            | 'postmessagewindow'
            | 'postmessageiframe'
        host: string
        port: number
        path?: string
        protocol?: string
    }
}

export class SpliceWalletJSONRPCUserAPI {
    public rpc: Client
    public static openrpcDocument: OpenRPC = {
        openrpc: '1.2.6',
        info: {
            title: 'Splice Wallet JSON-RPC User API',
            version: '1.0.0',
            description:
                'An OpenRPC specification for the user to interact with the wallet kernel.',
        },
        methods: [
            {
                name: 'addNetwork',
                params: [
                    {
                        name: 'network',
                        schema: { title: 'AddNetworkParams', type: 'object' },
                    },
                ],
                result: {
                    name: 'result',
                    schema: {
                        title: 'Null',
                        schema: { $ref: '#/components/schemas/Null' },
                        description:
                            'Represents a null value, used in responses where no data is returned.',
                    },
                },
                description:
                    'Adds a new network configuration (similar to EIP-3085).',
            },
            {
                name: 'allocateParty',
                params: [
                    {
                        name: 'params',
                        schema: {
                            title: 'AllocatePartyParams',
                            type: 'object',
                            properties: { hint: { type: 'string' } },
                            required: ['hint'],
                        },
                    },
                ],
                result: {
                    name: 'result',
                    schema: { title: 'AllocatePartyResult', type: 'object' },
                },
                description: 'Allocates a new party with the given hint.',
            },
            {
                name: 'removeParty',
                params: [
                    {
                        name: 'params',
                        schema: {
                            title: 'RemovePartyParams',
                            type: 'object',
                            properties: { hint: { type: 'string' } },
                            required: ['hint'],
                        },
                    },
                ],
                result: {
                    name: 'result',
                    schema: { title: 'RemovePartyResult', type: 'object' },
                },
                description: 'Removes a party with the given hint.',
            },
            {
                name: 'sign',
                params: [
                    {
                        name: 'params',
                        schema: {
                            title: 'SignParams',
                            type: 'object',
                            properties: {
                                data: { type: 'string' },
                                party: { type: 'string' },
                            },
                            required: ['data'],
                        },
                    },
                ],
                result: {
                    name: 'result',
                    schema: {
                        title: 'SignResult',
                        type: 'object',
                        properties: {
                            signature: { type: 'string' },
                            party: { type: 'string' },
                            signedBy: { type: 'string' },
                        },
                        required: ['signature', 'party', 'signedBy'],
                    },
                },
                description:
                    'Signs the provided data with the private key of the specified or active party.',
            },
            {
                name: 'execute',
                params: [
                    {
                        name: 'params',
                        schema: {
                            title: 'ExecuteParams',
                            type: 'object',
                            properties: {
                                signature: { type: 'string' },
                                party: { type: 'string' },
                                signedBy: { type: 'string' },
                            },
                            required: ['signature', 'party', 'signedBy'],
                        },
                    },
                ],
                result: {
                    name: 'result',
                    schema: {
                        title: 'ExecuteResult',
                        type: 'object',
                        properties: {
                            correlationId: { type: 'string' },
                            traceId: { type: 'string' },
                        },
                        required: ['correlationId', 'traceId'],
                    },
                },
                description: 'Executes a signed transaction.',
            },
        ],
        components: {
            schemas: {
                Null: {
                    title: 'Null',
                    type: 'null',
                    description:
                        'Represents a null value, used in responses where no data is returned.',
                },
            },
        },
    }
    public dereffedDocument: OpenRPC | undefined
    public transport:
        | HTTPTransport
        | WebSocketTransport
        | PostMessageWindowTransport
        | PostMessageIframeTransport
    private validator: MethodCallValidator | undefined
    private timeout: number | undefined

    constructor(options: Options) {
        if (
            options.transport === undefined ||
            options.transport.type === undefined
        ) {
            throw new Error('Invalid constructor params')
        }
        const { type, host, port, protocol } = options.transport
        let path = options.transport.path || ''
        if (path && path[0] !== '/') {
            path = '/' + path
        }
        switch (type) {
            case 'http':
            case 'https':
                this.transport = new HTTPTransport(
                    (protocol || type) + '://' + host + ':' + port + path
                )
                break
            case 'websocket':
                this.transport = new WebSocketTransport(
                    (protocol || 'ws://') + host + ':' + port + path
                )
                break
            case 'postmessageiframe':
                this.transport = new PostMessageIframeTransport(
                    protocol + '://' + host + ':' + port + path
                )
                break
            case 'postmessagewindow':
                this.transport = new PostMessageWindowTransport(
                    protocol + '://' + host + ':' + port + path
                )
                break
            default:
                throw new Error('unsupported transport')
        }
        this.rpc = new Client(new RequestManager([this.transport]))
    }

    /**
     * Adds a JSONRPC notification handler to handle receiving notifications.
     * @example
     * myClient.onNotification((data)=>console.log(data));
     */
    private async initialize() {
        if (this.validator) {
            return
        }
        this.dereffedDocument = await parseOpenRPCDocument(
            SpliceWalletJSONRPCUserAPI.openrpcDocument
        )
        this.validator = new MethodCallValidator(this.dereffedDocument)
    }

    /**
     * Adds a JSONRPC notification handler to handle receiving notifications.
     * @example
     * myClient.onNotification((data)=>console.log(data));
     */
    public onNotification(callback: (data: any) => void) {
        this.rpc.onNotification(callback)
    }

    /**
     * Adds an optional JSONRPCError handler to handle receiving errors that cannot be resolved to a specific request
     * @example
     * myClient.onError((err: JSONRPCError)=>console.log(err.message));
     */
    public onError(callback: (data: JSONRPCError) => void) {
        this.rpc.onError(callback)
    }

    /**
     * Sets a default timeout in ms for all requests excluding notifications.
     * @example
     * // 20s timeout
     * myClient.setDefaultTimeout(20000);
     * // Removes timeout from request
     * myClient.setDefaultTimeout(undefined);
     */
    public setDefaultTimeout(ms?: number) {
        this.timeout = ms
    }

    /**
     * Initiates [[SpliceWalletJSONRPCUserAPI.startBatch]] in order to build a batch call.
     *
     * Subsequent calls to [[SpliceWalletJSONRPCUserAPI.request]] will be added to the batch.
     * Once [[SpliceWalletJSONRPCUserAPI.stopBatch]] is called, the promises for the [[SpliceWalletJSONRPCUserAPI.request]]
     * will then be resolved.  If there is already a batch in progress this method is a noop.
     *
     * @example
     * myClient.startBatch();
     * myClient.foo().then(() => console.log("foobar"))
     * myClient.bar().then(() => console.log("foobarbaz"))
     * myClient.stopBatch();
     */
    public startBatch(): void {
        return this.rpc.startBatch()
    }

    /**
     * Initiates [[Client.stopBatch]] in order to finalize and send the batch to the underlying transport.
     *
     * stopBatch will send the [[SpliceWalletJSONRPCUserAPI]] calls made since the last [[SpliceWalletJSONRPCUserAPI.startBatch]] call. For
     * that reason, [[SpliceWalletJSONRPCUserAPI.startBatch]] MUST be called before [[SpliceWalletJSONRPCUserAPI.stopBatch]].
     *
     * @example
     * myClient.startBatch();
     * myClient.foo().then(() => console.log("foobar"))
     * myClient.bar().then(() => console.log("foobarbaz"))
     * myClient.stopBatch();
     */
    public stopBatch(): void {
        return this.rpc.stopBatch()
    }

    private async request(methodName: string, params: any[]): Promise<any> {
        await this.initialize()
        if (this.validator === undefined) {
            throw new Error('internal error')
        }
        const methodObject = _.find(
            SpliceWalletJSONRPCUserAPI.openrpcDocument
                .methods as MethodObject[],
            ({ name }) => name === methodName
        ) as MethodObject
        const notification = methodObject.result ? false : true
        const openRpcMethodValidationErrors = this.validator.validate(
            methodName,
            params
        )
        if (
            openRpcMethodValidationErrors instanceof MethodNotFoundError ||
            openRpcMethodValidationErrors.length > 0
        ) {
            return Promise.reject(openRpcMethodValidationErrors)
        }

        let rpcParams
        if (
            methodObject.paramStructure &&
            methodObject.paramStructure === 'by-name'
        ) {
            rpcParams = _.zipObject(_.map(methodObject.params, 'name'), params)
        } else {
            rpcParams = params
        }
        if (notification) {
            return this.rpc.notify({ method: methodName, params: rpcParams })
        }
        return this.rpc.request(
            { method: methodName, params: rpcParams },
            this.timeout
        )
    }

    /**
     *
     */
    // tslint:disable-next-line:max-line-length
    public addNetwork: AddNetwork = (...params) => {
        return this.request('addNetwork', params)
    }

    /**
     *
     */
    // tslint:disable-next-line:max-line-length
    public allocateParty: AllocateParty = (...params) => {
        return this.request('allocateParty', params)
    }

    /**
     *
     */
    // tslint:disable-next-line:max-line-length
    public removeParty: RemoveParty = (...params) => {
        return this.request('removeParty', params)
    }

    /**
     *
     */
    // tslint:disable-next-line:max-line-length
    public sign: Sign = (...params) => {
        return this.request('sign', params)
    }

    /**
     *
     */
    // tslint:disable-next-line:max-line-length
    public execute: Execute = (...params) => {
        return this.request('execute', params)
    }
}
export default SpliceWalletJSONRPCUserAPI
